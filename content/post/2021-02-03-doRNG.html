---
title: doRNG 패키지로 foreach를 재현가능하도록 사용하기
date: '2021-02-03'
coverImage: 
coverMeta: out
metaAlignment: center
categories:
  - R
tags:
  - R
  - R 꿀팁
  - 병렬처리
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p><strong>R</strong>에서 for 문의 느린 속도를 개선하기 위해 가장 많이 사용하는 방법 중 하나가 <strong>doParallel</strong> 패키지의 <code>foreach()</code>를 통해 병렬로 연산하는 것인데요.
하지만 seed를 설정하여 이후 같은 결과를 얻게 하는 <strong>재현성(reproducibility)을 위해서 <code>foreach()</code>를 사용할 때에는 주의할 필요</strong>가 있습니다.
보통 seed를 설정할 때 사용하는 <code>set.seed()</code>가 제대로 적용되지 않기 때문이죠.</p>
<p>다음의 예제를 확인해볼까요? <em>(본문에서 사용한 예제 코드는 doRNG 패키지의 RDocument를 참고하였습니다.)</em></p>
<p>각 반복마다 <span class="math inline">\(Uniform(0,1)\)</span>에서 sample 1개씩을 뽑는 과정을 <code>foreach()</code> 함수를 사용한 예제입니다.
그리고 재현성을 위해 <code>set.seed(1234)</code>를 설정해주었습니다.</p>
<pre class="r"><code>library(doParallel)
cl &lt;- makeCluster(2)
registerDoParallel(cl)

# foreach에서 %dopar% 구문으로 생성
set.seed(1234)
s1 &lt;- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

set.seed(1234)
s2 &lt;- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

# 두 벡터가 같은지 비교
identical(s1, s2)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>하지만 예상과 달리 seed를 지정해주었음에도 <code>runif()</code>에서 뽑힌 값이 다른 것을 확인할 수 있습니다. (<del>정확한 이유는 잘 모르겠습니다. . .</del>)</p>
<p><strong>그렇다면 이 문제는 어떻게 해결할 수 있을까요?</strong></p>
<blockquote>
<p>바로 <strong>doRNG</strong> 패키지를 사용하면 됩니다!!!</p>
</blockquote>
<p><br></p>
<div id="dorng-패키지" class="section level2">
<h2>doRNG 패키지</h2>
<p>앞에서의 문제는 <strong>doRNG</strong> 패키지 내의 <code>%dorng%</code> 또는 <code>registerDoRNG()</code>를 활용하여 해결할 수 있으며, 이제 두 방법을 하나씩 살펴보겠습니다.</p>
<div id="dorng-.options.rng" class="section level3">
<h3>1. %dorng% + .options.RNG</h3>
<p>첫 번째 방법은 <code>%dopar%</code>대신 <code>%dorng%</code>를 사용하는 것인데요.
이와 더불어 <code>.options.RNG</code> 옵션으로 seed를 설정해주어야 합니다.</p>
<p>다음에서 사용법과 간단한 예제를 확인해보겠습니다.
다음은 <code>%dorng% + .options.RNG = 1234</code>가 같은 값을 생성하는지 비교하는 예제입니다.</p>
<pre class="r"><code># 패키지 load
library(doRNG)

# %dorng% 구문으로 생성
r1 &lt;- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}

r2 &lt;- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}

# 두 벡터가 같은지 비교
identical(r1, r2)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p><code>set.seed()</code>를 사용했을 때와 달리 <code>%dorng% + .options.RNG</code>를 적용하여 생성된 두 벡터가 같은 것을 확인할 수 있습니다.</p>
</div>
<div id="registerdorng" class="section level3">
<h3>2. registerDoRNG</h3>
<p>두 번째 방법은 <code>registerDoRNG()</code> 함수를 사용하여 seed를 설정하는 것입니다.
<code>set.seed()</code>와 마찬가지로 함수 argument로 seed를 설정해주면 됩니다.</p>
<p>다음은 같은 seed로 <code>%dorng% + .options.RNG</code>와 <code>registerDoRNG()</code>가 같은 값을 생성하는지 비교하는 예제입니다.</p>
<pre class="r"><code># registerDoRNG로 seed 설정
registerDoRNG(1234)
r1 &lt;- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

# %dorng% 구문으로 seed 설정
r2 &lt;- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}

# 두 벡터가 같은지 비교
identical(r1, r2)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>사용하는 방법이 약간 다르지만, 두 방법에서 생성된 벡터가 서로 같다는 것을 확인할 수 있습니다.</p>
<p><br></p>
</div>
</div>
<div id="reference" class="section level2">
<h2>Reference</h2>
<ul>
<li><a href="https://www.stat.colostate.edu/~scharfh/CSP_parallel/handouts/foreach_handout.html">moving from for to foreach</a></li>
<li><a href="https://www.rdocumentation.org/packages/doRNG/versions/1.8.2/topics/%25dorng%25">RDocumentation - %dorng%</a></li>
<li><a href="https://www.rdocumentation.org/packages/doRNG/versions/1.8.2/topics/registerDoRNG">RDocumentation - registerDoRNG</a></li>
</ul>
</div>
