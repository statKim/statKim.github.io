---
title: doRNG 패키지로 foreach를 재현가능하도록 사용하기
date: '2021-02-03'
coverImage: 
coverMeta: out
metaAlignment: center
categories:
  - R
tags:
  - R
  - R 꿀팁
  - 병렬처리
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      # cache = T,
                      fig.align = "center", fig.width = 12, fig.height = 6)
```


for 문의 느린 속도를 개선하기 위해 병렬처리를 사용하게 되고, **R**에서는 이를 위해 **doParallel** 패키지의 `foreach()`를 많이 사용하는데요.

하지만 seed를 설정하여 이후 같은 결과를 얻게 되는 **재현성(reproducibility)을 위해서 `foreach()`를 사용할 때에는 주의**할 필요가 있습니다.
보통 seed를 설정할 때 사용하는 `set.seed()`가 제대로 적용되지 않기 때문이죠.

다음의 예제를 확인해볼까요?
여기서는 $Uniform(0,1)$에서 1개씩 sample을 뽑는 과정을 `foreach()`로 병렬처리하여 4번 반복하는 과정입니다.
그리고 재현성을 위해 `set.seed(1234)`를 설정해주었습니다. *(이번 포스팅에서의 예제코드는 doRNG 패키지의 RDocument 예제를 인용하였습니다.)*

```{r, echo = TRUE}
library(doParallel)
cl <- makeCluster(2)
registerDoParallel(cl)

# foreach에서 %dopar% 구문으로 생성
set.seed(1234)
s1 <- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

set.seed(1234)
s2 <- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

# 두 벡터가 같은지 비교
identical(s1, s2)
```

하지만 `set.seed()`를 적용하여 생성된 두 벡터는 다르다는 것을 확인할 수 있습니다.
이와 같이 같은 seed를 주었음에도 생성된 두 벡터가 다르다는 것을 확인할 수 있습니다.
**그렇다면 이 문제는 어떻게 해결할 수 있을까요?**

<br>

## doRNG 패키지

앞에서의 문제는 **doRNG** 패키지의 `%dorng%` 또는 `registerDoRNG()`를 활용하여 해결할 수 있으며, 다음에서 차근차근 살펴보겠습니다.

### 1. %dorng% + .options.RNG
첫 번째로 `%dopar%`대신 `%dorng%`를 사용하는 것인데요.
이와 더불어 `.options.RNG` 옵션으로 seed를 설정할 수 있습니다.
다음에서는 `.options.RNG = 1234`로 생성한 두 벡터가  같은지 비교해보았습니다.

```{r, echo = TRUE}
# 패키지 load
library(doRNG)

# %dorng% 구문으로 생성
r1 <- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}

r2 <- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}
identical(r1, r2)
```

이전과 달리 `%dorng%`와 `.options.RNG`를 적용하여 생성된 두 벡터가 같은 것을 확인할 수 있습니다.


### 2. registerDoRNG
두 번째 방법은 `registerDoRNG()` 함수를 사용하여 seed를 설정하는 것입니다.
`set.seed()`와 마찬가지로 함수 argument로 seed를 설정해주면 됩니다.

다음은 같은 seed로 `%dorng%`와 `registerDoRNG()`의 결과를 비교해보는 예시입니다.

```{r, echo = TRUE}
# registerDoRNG로 seed 설정
registerDoRNG(1234)
r1 <- foreach(i = 1:4) %dopar% { 
  runif(1) 
}

# %dorng% 구문으로 seed 설정
r2 <- foreach(i = 1:4, .options.RNG = 1234) %dorng% { 
  runif(1) 
}

identical(r1, r2)
```

두 방법에서 생성한 벡터가 서로 같다는 것을 확인할 수 있습니다.



```{r, echo = FALSE}
# stop cluster
stopCluster(cl)
```


<br>

## Reference
- [moving from for to foreach](https://www.stat.colostate.edu/~scharfh/CSP_parallel/handouts/foreach_handout.html)
- [RDocumentation-%dorng%](https://www.rdocumentation.org/packages/doRNG/versions/1.8.2/topics/%25dorng%25)
- [RDocumentation-registerDoRNG](https://www.rdocumentation.org/packages/doRNG/versions/1.8.2/topics/registerDoRNG)